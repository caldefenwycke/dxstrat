<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Darwin X — Live Headers</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js">
let _prevStartedTs = null;
function deriveRates(series){
  if(!series || series.length<2) return [];
  const rates=[];
  for(let i=1;i<series.length;i++){
    const a=series[i-1], b=series[i];
    const dt=(b.ts-a.ts)||1; const dg=b.generated_since_template-a.generated_since_template;
    rates.push(dg/dt);
  }
  return rates;
}
async function drawSpark(){
  const mins = document.getElementById('win').value || 60;
  const ser = await fetch('/darwinx/series?minutes='+mins).then(r=>r.json()).catch(_=>({items:[]}));
  lastSeries = ser.items || [];
  const rates = deriveRates(lastSeries);
  const ctx = document.getElementById('spark').getContext('2d');
  window._spark && window._spark.destroy();
  window._spark = new Chart(ctx, {
    type:'line',
    data:{ labels: rates.map((_,i)=>i), datasets:[{ label:'hdr/s', data: rates, fill:false, tension:0.2 }] },
    options:{ responsive:true, animation:false, plugins:{ legend:{ display:false } }, scales:{ x:{ display:false }, y:{ display:false } } }
  });
}
async function loadTopN(){
  const s = await fetch('/darwinx/stats').then(r=>r.json()).catch(_=>null);
  if(!s || !s.ok) return;
  // reset indicator
  if(_prevStartedTs !== null && _prevStartedTs !== s.started_ts){
    const b = document.getElementById('resetBadge'); b.style.display='inline-block'; setTimeout(()=>{b.style.display='none'}, 5000);
  }
  _prevStartedTs = s.started_ts;

  const tbody = document.getElementById('topN'); if(!tbody) return;
  tbody.innerHTML='';
  const list = s.top_list || [];
  list.forEach((j,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${j.score?.toFixed(6)}</td><td>${j.hash_norm?.toFixed(6)}</td><td>${j.entropy?.toFixed(6)}</td><td class="small">${j.job_id||''}</td>`;
    tbody.appendChild(tr);
  });
}

</script>
<style>
:root{--bg:#0b0f14;--card:#121922;--fg:#e6f0ff;--muted:#94a3b8;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu}
header{padding:16px 20px;background:#0f172a;border-bottom:1px solid #1f2937}
h1{margin:0;font-size:18px}
.container{max-width:1100px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stat{padding:14px;border-radius:12px;background:#0f172a;border:1px solid #1f2937;text-align:center}
.stat .num{font-size:22px;font-weight:700}
.small{color:var(--muted);font-size:12px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid #243041;color:#cbd5e1;font-size:12px}
.addr{word-break:break-all}
</style>
</head>
<body>
<header><h1>Darwin X — Live Header Generation <span id="resetBadge" class="badge" style="margin-left:8px;display:none;">New template</span></h1></header>
<div class="container">
  <div class="grid">
    <div class="stat" style="grid-column: span 4;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="small">Header rate sparkline</div>
        <canvas id="spark" height="40" style="max-width:420px"></canvas>
      </div>
    </div>
    <div class="stat"><div class="num" id="pool">—</div><div>Pool Size (current)</div></div>
    <div class="stat"><div class="num" id="gen">—</div><div>Headers since template</div></div>
    <div class="stat"><div class="num" id="rate">—</div><div>Gen Rate</div><div class="small">approx headers/sec</div></div>
    <div class="stat"><div class="num" id="height">—</div><div>Template Height</div></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 6px;">Top Header (current)</h3>
    <div class="grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="stat"><div class="num" id="score">—</div><div>Darwin Score</div><div class="small">w(H)·(1-hash) + w(E)·(1-ent)</div></div>
      <div class="stat"><div class="num" id="hashn">—</div><div>Hash Norm</div><div class="small">0 (good) → 1 (bad)</div></div>
      <div class="stat"><div class="num" id="entr">—</div><div>Entropy</div><div class="small">0 (better) → 1 (worse)</div></div>
    </div>
    <div class="small">Weights: <span id="wts">—</span></div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div>Header Generation Since Template</div>
      <div class="small"><label>Window:</label>
        <select id="win" onchange="loadSeries()">
          <option value="15">15 min</option>
          <option value="60" selected>60 min</option>
          <option value="180">3 h</option>
          <option value="1440">24 h</option>
        </select>
      </div>
    </div>
    <canvas id="seriesChart" height="110"></canvas>
  </div>
</div>
<script>
let lastSeries = []
function fmtRate(hps){ if(hps>1000) return (hps).toFixed(0)+'/s'; return Math.round(hps)+'/s' }

async function loadStats(){
  const s = await fetch('/darwinx/stats').then(r=>r.json()).catch(_=>null);
  if(!s || !s.ok) return;
  document.getElementById('pool').textContent = s.pool_size_current ?? '—';
  document.getElementById('gen').textContent = s.generated_since_template ?? '—';
  document.getElementById('height').textContent = s.template_height ?? '—';
  const w = (s.w_hash||0).toFixed(2) + ' : ' + (s.w_ent||0).toFixed(2);
  document.getElementById('wts').textContent = 'hash : entropy = ' + w;
  document.getElementById('score').textContent = (s.top_score!=null? s.top_score.toFixed(6) : '—');
  document.getElementById('hashn').textContent = (s.top_hash_norm!=null? s.top_hash_norm.toFixed(6) : '—');
  document.getElementById('entr').textContent = (s.top_entropy!=null? s.top_entropy.toFixed(6) : '—');
  // crude rate from latest two series points if available
  if(lastSeries.length>=2){
    const a = lastSeries[lastSeries.length-2], b = lastSeries[lastSeries.length-1];
    const dt = (b.ts - a.ts) || 1; const dg = (b.generated_since_template - a.generated_since_template);
    document.getElementById('rate').textContent = fmtRate(dg/dt);
  }
}

async function loadSeries(){
  const mins = document.getElementById('win').value;
  const ser = await fetch('/darwinx/series?minutes='+mins).then(r=>r.json());
  lastSeries = ser.items || [];
  const labels = lastSeries.map(x=> new Date(x.ts*1000).toLocaleTimeString());
  const data = lastSeries.map(x=> x.generated_since_template);
  const ctx = document.getElementById('seriesChart').getContext('2d');
  window._seriesChart && window._seriesChart.destroy();
  window._seriesChart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label:'Cumulative headers since template', data, tension:0.2, fill:false }] },
    options:{ responsive:true, animation:false, scales:{ y:{ beginAtZero:true } } }
  });
}

async function tick(){
  await drawSpark();
  await loadTopN();
  await loadSeries();
  await loadStats();
}
tick(); setInterval(()=>{loadStats(); loadTopN(); drawSpark();}, 5000);

let _prevStartedTs = null;
function deriveRates(series){
  if(!series || series.length<2) return [];
  const rates=[];
  for(let i=1;i<series.length;i++){
    const a=series[i-1], b=series[i];
    const dt=(b.ts-a.ts)||1; const dg=b.generated_since_template-a.generated_since_template;
    rates.push(dg/dt);
  }
  return rates;
}
async function drawSpark(){
  const mins = document.getElementById('win').value || 60;
  const ser = await fetch('/darwinx/series?minutes='+mins).then(r=>r.json()).catch(_=>({items:[]}));
  lastSeries = ser.items || [];
  const rates = deriveRates(lastSeries);
  const ctx = document.getElementById('spark').getContext('2d');
  window._spark && window._spark.destroy();
  window._spark = new Chart(ctx, {
    type:'line',
    data:{ labels: rates.map((_,i)=>i), datasets:[{ label:'hdr/s', data: rates, fill:false, tension:0.2 }] },
    options:{ responsive:true, animation:false, plugins:{ legend:{ display:false } }, scales:{ x:{ display:false }, y:{ display:false } } }
  });
}
async function loadTopN(){
  const s = await fetch('/darwinx/stats').then(r=>r.json()).catch(_=>null);
  if(!s || !s.ok) return;
  // reset indicator
  if(_prevStartedTs !== null && _prevStartedTs !== s.started_ts){
    const b = document.getElementById('resetBadge'); b.style.display='inline-block'; setTimeout(()=>{b.style.display='none'}, 5000);
  }
  _prevStartedTs = s.started_ts;

  const tbody = document.getElementById('topN'); if(!tbody) return;
  tbody.innerHTML='';
  const list = s.top_list || [];
  list.forEach((j,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td><td>${j.score?.toFixed(6)}</td><td>${j.hash_norm?.toFixed(6)}</td><td>${j.entropy?.toFixed(6)}</td><td class="small">${j.job_id||''}</td>`;
    tbody.appendChild(tr);
  });
}

</script>
</body>
</html>

<div class="container">
  <div class="card">
    <h3 style="margin:0 0 6px;">Top Headers</h3>
    <table class="table">
      <thead><tr><th>#</th><th>Score</th><th>Hash Norm</th><th>Entropy</th><th>Job ID</th></tr></thead>
      <tbody id="topN"></tbody>
    </table>
  </div>
</div>
