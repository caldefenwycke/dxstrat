<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DarwinX Pool</title>
  <meta name="description" content="DarwinX Bitcoin mining pool – low fee, transparent API, simple setup." />
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0d10;
      --panel: #0f1419;
      --panel-2: #121820;
      --text: #e7edf3;
      --muted: #a9b4bf;
      --line: #1b242e;
      --accent: #58a6ff;
      --ok: #3fb950;
      --warn: #e3b341;
      --err: #f85149;
      --shadow: 0 6px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box }
    html,body { height: 100% }
    body { margin:0; background:var(--bg); color:var(--text); font: 16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji" }
    a { color: var(--accent); text-decoration: none }
    a:hover { text-decoration: underline }

    /* Topbar */
    .topbar { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(120%) blur(8px); background: rgba(11,13,16,.7); border-bottom:1px solid var(--line) }
    .topbar-inner { max-width: 1200px; margin:0 auto; display:flex; align-items:center; gap:18px; padding:12px 20px }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700 }
    .brand .dot { width:10px; height:10px; border-radius:50%; background: var(--ok); box-shadow: 0 0 0 3px rgba(63,185,80,.15) }
    nav { margin-left:auto; display:flex; gap:18px }
    nav a { opacity:.9 }

    /* Wrap & sections */
    .wrap { max-width: 1200px; margin: 0 auto; padding: 28px 20px 64px }
    .hero { display:grid; grid-template-columns: 1.2fr .8fr; gap:24px; align-items:stretch; margin-top:24px }
    @media (max-width: 870px){ .hero{ grid-template-columns: 1fr } }

    .card { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); }
    .card .pad { padding: 20px }
    .h1 { font-size: clamp(26px, 3vw, 36px); line-height:1.1; margin: 0 0 10px; letter-spacing: .2px }
    .muted { color: var(--muted) }
    .tag { display:inline-block; padding: 4px 10px; border:1px solid var(--line); border-radius: 999px; font-size: 12px; color:var(--muted) }

    .stats-strip { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-top: 14px }
    @media (max-width:920px){ .stats-strip { grid-template-columns: repeat(2, minmax(0,1fr)) } }
    @media (max-width:520px){ .stats-strip { grid-template-columns: 1fr } }
    .stat { padding:14px 16px; border:1px solid var(--line); border-radius:12px; background:#0d1217 }
    .stat .label { font-size:12px; color:var(--muted) }
    .stat .value { margin-top:6px; font-weight:700; font-size:18px }

    .grid { display:grid; gap:18px; grid-template-columns: repeat(3, minmax(0,1fr)); margin-top:24px }
    @media (max-width:1000px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)) } }
    @media (max-width:700px){ .grid{ grid-template-columns: 1fr } }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 14px }
    .kbd { font: 12px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#0d1217; padding:2px 6px; border-radius:6px; border:1px solid var(--line) }

    .btn { display:inline-flex; align-items:center; gap:10px; appearance:none; border:1px solid var(--line); background:#0d1217; color:var(--text); border-radius: 12px; padding:10px 14px; cursor:pointer }
    .btn:hover { background:#121821 }

    .list { display:grid; gap:10px; margin: 8px 0 0; padding:0; list-style:none }
    .list li { display:flex; gap:10px; align-items:flex-start }
    .list .dot { margin-top:.45em; width:7px; height:7px; background:var(--accent); border-radius:50% }

    .codeblock { position:relative; border:1px solid var(--line); border-radius:12px; overflow:auto; background: #0d1217 }
    .codeblock pre { margin:0; padding:14px }
    .codeblock .copy { position:absolute; top:8px; right:8px }

    .mini { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .kvs { display:grid; grid-template-columns: auto 1fr; gap:8px 12px }
    .kv .k { color:var(--muted) }

    .search { display:flex; gap:10px; align-items:center; margin-top:10px }
    .search input { flex:1; border-radius:12px; background:#0d1217; color:var(--text); border:1px solid var(--line); padding:10px 12px }

    .table { width:100%; border-collapse: collapse; margin-top:10px; font-size:14px }
    .table th, .table td { border-bottom:1px solid var(--line); padding:10px 8px; text-align:left }
    .table th { color:var(--muted); font-weight:600; background:#0b1116 }
    .empty { padding:20px; text-align:center; color:var(--muted) }

    footer { margin-top: 48px; color: var(--muted) }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand"><span class="dot" aria-hidden="true"></span> DarwinX Pool</div>
      <nav>
        <a href="#connect">Connect</a>
        <a href="#stats">Stats</a>
        <a href="#miner">Miner Lookup</a>
        <a href="#about">About</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- HERO + HEADER STATS -->
    <section class="hero">
      <div class="card">
        <div class="pad">
          <div class="tag" id="poolDomain">pool.dxstrat.com</div>
          <h1 class="h1">Mine Bitcoin with a lightweight, transparent pool</h1>
          <p class="muted">No sign‑ups. Point your miner at our stratum, use your <strong>BTC address</strong> as the username, and watch stats update live via our <code class="kbd">/api</code>.</p>

          <div class="stats-strip" aria-live="polite">
            <div class="stat"><div class="label">Pool hashrate (5m)</div><div class="value" id="statHash5m">—</div></div>
            <div class="stat"><div class="label">Miners online</div><div class="value" id="statMiners">—</div></div>
            <div class="stat"><div class="label">Blocks found</div><div class="value" id="statBlocks">—</div></div>
            <div class="stat"><div class="label">Fee</div><div class="value" id="statFee">—</div></div>
          </div>
        </div>
      </div>

      <div class="card" id="connect">
        <div class="pad">
          <h2 style="margin:0 0 10px">Quick connect</h2>
          <p class="muted" style="margin:0 0 10px">Point your miner to our stratum endpoint. Username = your BTC address. Password can be anything.</p>
          <div class="codeblock" style="margin-top:8px">
            <button class="btn copy" data-copy="#stratum">Copy</button>
            <pre class="mono" id="stratum">stratum+tcp://pool.dxstrat.com:3333</pre>
          </div>

          <div style="height:10px"></div>
          <details>
            <summary class="mini"><span class="kbd">cgminer</span> / <span class="kbd">bfgminer</span> example</summary>
            <div class="codeblock" style="margin-top:10px">
              <button class="btn copy" data-copy="#ex1">Copy</button>
              <pre class="mono" id="ex1"># Replace with YOUR BTC address
cgminer -o stratum+tcp://pool.dxstrat.com:3333 -u bc1qYOURADDRESS -p x
# or bfgminer
bfgminer -o stratum+tcp://pool.dxstrat.com:3333 -u bc1qYOURADDRESS -p x</pre>
            </div>
          </details>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section class="grid" id="stats" aria-live="polite">
      <div class="card">
        <div class="pad">
          <h3 style="margin:0 0 8px">Pool overview</h3>
          <div class="kvs">
            <div class="kv"><div class="k">Name</div><div id="kvName">—</div></div>
            <div class="kv"><div class="k">Domain</div><div id="kvDomain">—</div></div>
            <div class="kv"><div class="k">Fee</div><div id="kvFee">—</div></div>
            <div class="kv"><div class="k">Height</div><div id="kvHeight">—</div></div>
            <div class="kv"><div class="k">Last block</div><div id="kvLastBlock">—</div></div>
            <div class="kv"><div class="k">Round shares</div><div id="kvRound">—</div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pad">
          <h3 style="margin:0 0 8px">Hashrate</h3>
          <div class="kvs">
            <div class="kv"><div class="k">5 minutes</div><div id="kvH5">—</div></div>
            <div class="kv"><div class="k">1 hour</div><div id="kvH1">—</div></div>
            <div class="kv"><div class="k">24 hours</div><div id="kvH24">—</div></div>
            <div class="kv"><div class="k">Miners online</div><div id="kvMiners">—</div></div>
            <div class="kv"><div class="k">Workers</div><div id="kvWorkers">—</div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pad">
          <h3 style="margin:0 0 8px">API health</h3>
          <div id="apiHealth" class="mini">
            <span class="kbd">/api/pool</span>
            <span class="kbd">/api/stats</span>
            <span id="apiErr" class="muted"></span>
          </div>
          <p class="muted" style="margin-top:8px">All numbers auto‑refresh ~30s.</p>
        </div>
      </div>
    </section>

    <!-- MINER LOOKUP -->
    <section class="card" id="miner" style="margin-top:24px">
      <div class="pad">
        <h3 style="margin:0 0 6px">Miner lookup</h3>
        <p class="muted">Enter your payout <strong>BTC address</strong> (or account/worker, depending on your miner). We’ll call <code class="kbd">/api/miner/&lt;addr&gt;</code>.</p>
        <form class="search" id="minerForm">
          <input id="minerInput" placeholder="bc1q... or 1ABC..." autocomplete="off" />
          <button class="btn" type="submit">Lookup</button>
        </form>
        <div id="minerStatus" class="muted" style="margin-top:8px"></div>
        <div id="minerSummary" class="stats-strip" style="margin-top:12px"></div>
        <div id="minerWorkersWrap" style="margin-top:10px"></div>
        <details style="margin-top:10px">
          <summary class="mini"><span class="kbd">Raw JSON</span> (debug)</summary>
          <pre id="minerRaw" class="mono" style="white-space:pre-wrap"></pre>
        </details>
      </div>
    </section>

    <!-- ABOUT -->
    <section class="card" id="about" style="margin-top:24px">
      <div class="pad">
        <h3 style="margin:0 0 6px">What makes this pool different</h3>
        <ul class="list">
          <li><span class="dot"></span><div>Simple setup: use your BTC address as the username; no accounts.</div></li>
          <li><span class="dot"></span><div>Transparent API and open configuration. Low 2% fee.</div></li>
          <li><span class="dot"></span><div>Modern, lightweight stratum and web stack.</div></li>
        </ul>
      </div>
    </section>

    <footer class="wrap" style="padding-left:0;padding-right:0">
      <div class="muted">© <span id="year"></span> DarwinX. Built for Bitcoin miners. • <a href="https://github.com/caldefenwycke/dxstrat" rel="noopener">GitHub</a></div>
    </footer>
  </main>

  <script>
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function formatHashrate(h) {
      if (h == null || isNaN(h)) return '—';
      const units = ['H/s','kH/s','MH/s','GH/s','TH/s','PH/s','EH/s'];
      let i = 0; let v = Number(h);
      while (v >= 1000 && i < units.length-1) { v /= 1000; i++; }
      return v.toFixed(v < 10 ? 2 : v < 100 ? 1 : 0) + ' ' + units[i];
    }
    function fmtNum(n){
      if (n == null || isNaN(n)) return '—';
      return Number(n).toLocaleString();
    }
    function fmtTime(ts){
      if (!ts) return '—';
      const d = typeof ts === 'number' && ts < 2e12 ? new Date(ts*1000) : new Date(ts);
      return d.toLocaleString();
    }

    async function fetchJSON(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(url+': '+res.status);
      return res.json();
    }

    async function loadPool() {
      try {
        const pool = await fetchJSON('/api/pool');
        $('#kvName').textContent = pool.name ?? 'DarwinX Pool';
        $('#kvDomain').textContent = pool.domain ?? 'dxstrat.com';
        $('#poolDomain').textContent = (pool.domain ? ('pool.'+pool.domain) : 'pool.dxstrat.com');
        const fee = (pool.fee_percent!=null)? pool.fee_percent+'%':'—';
        $('#kvFee').textContent = fee;
        $('#statFee').textContent = fee;
      } catch (e) {
        console.warn('pool api failed', e);
        $('#apiErr').textContent = 'API error: '+e.message;
      }
    }

    async function loadStats() {
      try {
        const s = await fetchJSON('/api/stats');
        // try a list of common keys; show what we find
        const hr5 = s.hashrate_5m ?? s.pool_hashrate_5m ?? s.hashrate5m ?? s.hash_5m;
        const hr1 = s.hashrate_1h ?? s.pool_hashrate_1h ?? s.hashrate1h ?? s.hash_1h;
        const hr24 = s.hashrate_24h ?? s.pool_hashrate_24h ?? s.hashrate24h ?? s.hash_24h;
        const miners = s.miners_online ?? s.miners ?? s.active_miners ?? s.clients ?? s.workers_online;
        const workers = s.workers ?? s.workers_online ?? s.active_workers;
        const blocks = s.total_blocks_found ?? s.blocks_found ?? s.blocks;
        const roundShares = s.round_shares ?? s.current_round_shares ?? s.shares_round;
        const height = s.last_block_height ?? s.height ?? s.block_height;
        const lastBlockTime = s.last_block_found_at ?? s.last_block_time;

        $('#statHash5m').textContent = formatHashrate(hr5);
        $('#statMiners').textContent = fmtNum(miners);
        $('#statBlocks').textContent = fmtNum(blocks);

        $('#kvH5').textContent = formatHashrate(hr5);
        $('#kvH1').textContent = formatHashrate(hr1);
        $('#kvH24').textContent = formatHashrate(hr24);
        $('#kvMiners').textContent = fmtNum(miners);
        $('#kvWorkers').textContent = fmtNum(workers);
        $('#kvRound').textContent = roundShares!=null? fmtNum(roundShares) : '—';
        $('#kvHeight').textContent = height!=null? fmtNum(height) : '—';
        $('#kvLastBlock').textContent = lastBlockTime? fmtTime(lastBlockTime) : '—';

        // mark API healthy
        $('#apiErr').textContent = '';
      } catch (e) {
        console.warn('stats api failed', e);
        $('#apiErr').textContent = 'API error: '+e.message;
      }
    }

    async function lookupMiner(addr) {
      $('#minerStatus').textContent = 'Looking up…';
      $('#minerSummary').innerHTML = '';
      $('#minerWorkersWrap').innerHTML = '';
      $('#minerRaw').textContent = '';
      try {
        const data = await fetchJSON('/api/miner/'+encodeURIComponent(addr));
        $('#minerRaw').textContent = JSON.stringify(data, null, 2);
        $('#minerStatus').textContent = '';

        // Try to discover common fields for a summary
        const hr = data.hashrate ?? data.hashrate_5m ?? data.total_hashrate ?? data.hr;
        const bal = data.balance_sats ?? data.payout_balance_sats ?? data.balance ?? data.pending_sats;
        const paid = data.total_paid_sats ?? data.paid_sats ?? data.total_paid;
        const last = data.last_share ?? data.last_share_time ?? data.updated_at ?? data.lastSeen;
        const workers = data.workers ?? data.devices ?? (Array.isArray(data) ? data : null);

        const summary = [];
        summary.push(['Hashrate', formatHashrate(hr)]);
        if (bal!=null) summary.push(['Balance (sats)', fmtNum(bal)]);
        if (paid!=null) summary.push(['Total paid (sats)', fmtNum(paid)]);
        if (last) summary.push(['Last share', fmtTime(last)]);

        if (summary.length) {
          summary.forEach(([k,v])=>{
            const d = document.createElement('div');
            d.className = 'stat';
            d.innerHTML = `<div class="label">${k}</div><div class="value">${v}</div>`;
            $('#minerSummary').appendChild(d);
          });
        }

        // Workers table if present
        const list = Array.isArray(workers) ? workers : (workers && typeof workers === 'object' ? Object.values(workers) : null);
        if (list && list.length) {
          const wrap = document.createElement('div');
          const table = document.createElement('table');
          table.className = 'table';
          table.innerHTML = `<thead><tr>
            <th>Worker</th><th>Hashrate</th><th>Shares</th><th>Last Share</th>
          </tr></thead><tbody></tbody>`;
          const tbody = table.querySelector('tbody');
          list.forEach(w => {
            const name = w.name ?? w.worker ?? w.id ?? '—';
            const wh = w.hashrate ?? w.hr ?? w.hashrate_5m;
            const shares = w.shares ?? w.accepted ?? w.valid ?? w.valid_shares;
            const lastw = w.last_share ?? w.last_share_time ?? w.updated_at;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${name}</td><td>${formatHashrate(wh)}</td><td>${shares!=null?fmtNum(shares):'—'}</td><td>${lastw?fmtTime(lastw):'—'}</td>`;
            tbody.appendChild(tr);
          });
          wrap.appendChild(table);
          $('#minerWorkersWrap').appendChild(wrap);
        } else {
          $('#minerWorkersWrap').innerHTML = '<div class="empty">No worker details returned.</div>';
        }
      } catch (e) {
        $('#minerStatus').textContent = 'Lookup failed: '+e.message;
      }
    }

    function wireCopyButtons(){
      $$('.copy').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const sel = btn.getAttribute('data-copy');
          const el = document.querySelector(sel);
          const text = el ? (el.innerText || el.textContent) : '';
          if (!text) return;
          navigator.clipboard.writeText(text.trim()).then(()=>{
            btn.textContent = 'Copied';
            setTimeout(()=> btn.textContent = 'Copy', 1200);
          });
        });
      });
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      $('#year').textContent = new Date().getFullYear();
      wireCopyButtons();
      loadPool();
      loadStats();
      setInterval(loadStats, 30_000);

      $('#minerForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const addr = $('#minerInput').value.trim();
        if (!addr) { $('#minerStatus').textContent = 'Enter an address'; return; }
        lookupMiner(addr);
      });
    });
  </script>
  <noscript><div style="padding:16px" class="muted">Enable JavaScript to see live stats.</div></noscript>
</body>
</html>
